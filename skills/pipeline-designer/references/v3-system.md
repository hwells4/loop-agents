# V3 System Reference

The V3 system uses structured context and status files. All pipelines use this format.

## Template Variables

### Primary Variables (V3)

| Variable | Description |
|----------|-------------|
| `${CTX}` | Path to `context.json` - full session metadata |
| `${STATUS}` | Path where agent writes `status.json` |
| `${PROGRESS}` | Path to progress file (accumulated context) |
| `${ITERATION}` | Current iteration number (1-based) |
| `${SESSION_NAME}` | Session identifier |

### Multi-Stage Variables

| Variable | Description |
|----------|-------------|
| `${INPUTS}` | Previous stage outputs (multi-stage only) |
| `${INPUTS.stage-name}` | Named stage outputs (when multiple inputs) |
| `${OUTPUT}` | Path to write this stage's output |

### Legacy Variables (Deprecated, Still Work)

| Variable | Maps To |
|----------|---------|
| `${SESSION}` | `${SESSION_NAME}` |
| `${INDEX}` | `${ITERATION} - 1` (0-based) |
| `${PROGRESS_FILE}` | `${PROGRESS}` |

## context.json Format

Generated by the engine, available at `${CTX}`:

```json
{
  "session": {
    "name": "auth-refactor",
    "type": "work",
    "started_at": "2026-01-12T10:00:00Z"
  },
  "iteration": {
    "current": 5,
    "max": 25,
    "started_at": "2026-01-12T10:25:00Z"
  },
  "paths": {
    "progress": ".claude/pipeline-runs/auth-refactor/progress-auth-refactor.md",
    "status": ".claude/pipeline-runs/auth-refactor/iterations/005/status.json",
    "output": ".claude/pipeline-runs/auth-refactor/iterations/005/output.md"
  },
  "termination": {
    "type": "queue",
    "config": {}
  },
  "history": [
    {"iteration": 1, "decision": "continue"},
    {"iteration": 2, "decision": "continue"},
    {"iteration": 3, "decision": "continue"},
    {"iteration": 4, "decision": "continue"}
  ]
}
```

## status.json Format

Agent writes this to `${STATUS}` at end of each iteration:

```json
{
  "decision": "continue | stop | error",
  "reason": "Why this decision was made",
  "summary": "What happened this iteration",
  "work": {
    "items_completed": ["beads-001", "beads-002"],
    "files_touched": ["src/auth.ts", "tests/auth.test.ts"]
  },
  "errors": []
}
```

### Decision Values

| Decision | Meaning |
|----------|---------|
| `continue` | More work to do, run another iteration |
| `stop` | Work complete, terminate the pipeline |
| `error` | Something went wrong, terminate with error |

### For Judgment Termination

When using `judgment` termination, the `decision` field is critical:
- Agent must independently assess if quality has plateaued
- Write `decision: stop` when genuinely satisfied
- Engine checks for N consecutive `stop` decisions (consensus)

## Loop Configuration (loop.yaml)

```yaml
name: stage-name
description: One-sentence description

termination:
  type: queue | judgment | fixed
  min_iterations: 2      # judgment only: start checking after this
  consensus: 2           # judgment only: consecutive stops needed
  max_iterations: 25     # optional hard cap

check_before: true       # Check termination before first iteration
delay: 3                 # Seconds between iterations
model: opus              # opus | sonnet | haiku
```

## Pipeline Configuration

```yaml
name: pipeline-name
description: What the pipeline accomplishes

stages:
  - name: stage-one
    loop: existing-stage-type  # Directory in scripts/stages/
    runs: 5                    # Max iterations for this stage

  - name: stage-two
    loop: another-stage-type
    runs: 3
    inputs:
      from: stage-one          # Receives outputs from stage-one
```

## Directory Structure

```
.claude/
├── pipeline-runs/
│   └── {session}/
│       ├── state.json              # Engine state (iteration, status)
│       ├── progress-{session}.md   # Accumulated context
│       └── iterations/
│           ├── 001/
│           │   ├── status.json     # Agent's status output
│           │   └── output.md       # Iteration output
│           ├── 002/
│           └── ...
├── locks/
│   └── {session}.lock              # Prevents concurrent sessions
└── pipeline-specs/
    └── {name}.yaml                 # Confirmed architecture specs

scripts/
├── loops/
│   └── {stage}/
│       ├── loop.yaml               # Stage configuration
│       └── prompt.md               # Prompt template
└── pipelines/
    └── {name}.yaml                 # Pipeline configuration
```

## Execution Commands

```bash
# Single-stage (equivalent)
./scripts/run.sh {type} {session} {max}
./scripts/run.sh loop {type} {session} {max}

# Multi-stage pipeline
./scripts/run.sh pipeline {name}.yaml {session}

# Validation
./scripts/run.sh lint loop {name}
./scripts/run.sh lint pipeline {name}.yaml

# Dry-run preview
./scripts/run.sh dry-run loop {name} preview
./scripts/run.sh dry-run pipeline {name}.yaml preview

# Session management
./scripts/run.sh status {session}
```
